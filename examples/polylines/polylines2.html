<html>

<head>
    <title>OpenGlobus - Earth planet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../css/og.css" type="text/css" />
</head>

<body>
    <div id="globus" style="width:100%;height:100%"></div>
    <script type="module">
        'use strict';

        import * as math from '../../src/og/math.js';
        import { Globe } from '../../src/og/Globe.js';
        import { LonLat } from '../../src/og/LonLat.js';
        import { Vec3 } from '../../src/og/math/Vec3.js';
        import { Quat } from '../../src/og/math/Quat.js';
        import { XYZ } from '../../src/og/layer/XYZ.js';
        import { Vector } from '../../src/og/layer/Vector.js';
        import { GlobusTerrain } from '../../src/og/terrain/GlobusTerrain.js';
        import { Ellipsoid } from '../../src/og/ellipsoid/Ellipsoid.js';
        import { Entity } from '../../src/og/entity/Entity.js';

        const POINTS_NUMBER = 100;

        fetch('routes.json')
            .then(res => res.json())
            .then(data => {

                let paths = [],
                    colors = [];

                for (let i = 0; i < data.length; i++) {
                    let p = data[i],
                        dst = new LonLat(Number(p.dstAirport.lng), Number(p.dstAirport.lat)),
                        src = new LonLat(Number(p.srcAirport.lng), Number(p.srcAirport.lat));

                    let path = getPath(globus.planet.ellipsoid, src, dst);

                    paths.push(path.path);
                    colors.push(path.colors);
                }

                let entity = new Entity({
                    'polyline': {
                        'path3v': paths,
                        'pathColors': colors,
                        'thickness': 0.8,
                        'color': "red",
                        'isClosed': false
                    }
                });

                collection.add(entity);

                //let dColor = [Math.random(), Math.random(), Math.random(), 1];

                //globus.planet.renderer.handler.defaultClock.setInterval(20, () => {
                //    let e = collection.getEntities()[0].polyline;
                //    let cArr = e.getPathColors();
                //    for (let i = 0; i < cArr.length; i++) {
                //        e.setPointColor(dColor, INDEX, i);
                //    }
                //    INDEX++;
                //    if (INDEX > POINTS_NUMBER) {
                //        dColor = [Math.random(), Math.random(), Math.random(), 1];
                //        INDEX = 0;
                //    }
                //});

            });

        function getPath(ell, start, end) {
            let num = POINTS_NUMBER;

            let brng = Ellipsoid.getInitialBearing(start, end);
            let dist = ell.getGreatCircleDistance(start, end);

            let p25 = ell.getGreatCircleDestination(start, brng, dist * 0.25),
                p75 = ell.getGreatCircleDestination(start, brng, dist * 0.75);

            start.height = 50;
            end.height = 50;
            let h = dist / 4;
            p25.height = h;
            p75.height = h;

            let startCart = ell.lonLatToCartesian(start),
                endCart = ell.lonLatToCartesian(end),
                p25Cart = ell.lonLatToCartesian(p25),
                p75Cart = ell.lonLatToCartesian(p75);

            let path = [],
                colors = [];
            let color = [Math.random(), Math.random(), Math.random()];
            for (let i = 0; i <= num; i++) {
                let cn = math.bezier3v(i / num, startCart, p25Cart, p75Cart, endCart);
                path.push(cn);

                colors.push([color[0], color[1], color[2], i / num + 0.05]);
            }


            return {
                path: path,
                colors: colors
            };
        }

        var collection = new Vector("Collection", {
            'entities': []
        });

        var osm = new XYZ("OpenStreetMap", {
            isBaseLayer: true,
            url: "//{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
            visibility: true,
            attribution: 'Data @ OpenStreetMap contributors, ODbL'
        });

        var globus = new Globe({
            "target": "globus",
            "name": "Earth",
            "layers": [osm, collection],
            "terrain": new GlobusTerrain()
        });

        window.INDEX = 0;

        window.globus = globus;

    </script>
</body>

</html>